---
title: 开发日志|RN导入高德地图
date: 2024-02-27 16:31:23
categories: [开发]
tags: [React Native,APP]
---





记录RN项目引入高德地图的过程

<!--more-->

### 安装包

使用的是[react-native-amap3d](https://github.com/qiuxiang/react-native-amap3d?tab=readme-ov-file#react-native-amap3d--)，

React Native版本v0.73.3，

包管理器为yarn

```
yarn add react-native-amap3d
```



## 获取API

### 认证

我通过个人支付宝认证，验证很快。

 ![image-20240227163848027](https://tazdingo-images.oss-cn-hongkong.aliyuncs.com/img/202402271638136.png)



### 获取SHA1码

#### 尝试在Android Studio终端获取

1. View->Tool Windows->Terminal里打开。

![Android Studio里打开终端](https://tazdingo-images.oss-cn-hongkong.aliyuncs.com/img/202402271659191.png)

2. 结果发现`keytool`命令无法识别。



查了一下，都说jdk的bin文件下有keytool命令，确实在bin文件夹里找到了，但是无法直接运行，在该位置下打开cmd执行keytool也还是无法识别。

最后把这个bin文件路径配置到Path环境变量中解决。

![keytool命令终于识别](https://tazdingo-images.oss-cn-hongkong.aliyuncs.com/img/202402271711444.png)



#### 通过cmd里获取

上面在cmd里测试keytool指令成功，现在切换到项目路径下的`android\app\debug.keystore`位置。

由于项目现在处于开发阶段，我获取的是开发板SHA1码。

```cmd
# 获取开发版的SHA1码
keytool -list -v -keystore debug.keystore
```

![SHA1码](https://tazdingo-images.oss-cn-hongkong.aliyuncs.com/img/202402271925293.png)



### 获取包名

这也是一个让我摸不着头脑的东西，根据高德地图官方文档所说

> 打开Android 应用工程的**”AndroidManifest.xml“**配置文件，package**属性所对应的内容**为应用包名。

（`android\app\src\main\AndroidManifest.xml`）

找到对应文件后，惊奇的发现这东西里面竟然没有`package = xxx`，但是其他文件里有，于是自己加上去试试。

 <img src="https://tazdingo-images.oss-cn-hongkong.aliyuncs.com/img/202402271931736.png" alt="申请Key" style="zoom: 50%;" />



## 引入地图

### 设置API key

在显示地图前调用接口设置 API key，这里我在App.tsx里设置。

```react
// App.tsx
import { AMapSdk } from "react-native-amap3d";
import { Platform } from "react-native";

AMapSdk.init(
  Platform.select({
    android: "c52c7169e6df23490e3114330098aaac"
  })
);
```



### 显示地图

```react
import { MapView, MapType } from "react-native-amap3d";

<MapView
  mapType={MapType.Satellite}
  initialCameraPosition={{
    target: {
      latitude: 39.91095,
      longitude: 116.37296,
    },
    zoom: 8,
  }}
/>;
```

 <img src="https://tazdingo-images.oss-cn-hongkong.aliyuncs.com/img/202402281431796.png" alt="显示正常" style="zoom:50%;" />

可以看到地图正常显示，接下来测试相关接口。

amap3d项目中提到的那些接口都可以开箱即用，就不多说了。



## 引入定位模块

......由于尝试使用amap3d的定位模块失败（不知道能不能用），就又装了推荐的隔壁[amap-geolocation](https://github.com/qiuxiang/react-native-amap-geolocation)。

### 安装包

```
yarn add react-native-amap-geolocation
```

结果会发现冲突了，报了一大堆错：

```javascript
Execution failed for task ':app:checkDebugDuplicateClasses'.
> A failure occurred while executing com.android.build.gradle.internal.tasks.CheckDuplicatesRunnable
   > Duplicate class com.amap.api.fence.DistrictItem found in modules jetified-3dmap-9.6.0 (com.amap.api:3dmap:9.6.0) and jetified-location-6.2.0 (com.amap.api:location:6.2.0)
     Duplicate class com.amap.api.fence.DistrictItem$1 found in modules jetified-3dmap-9.6.0 (com.amap.api:3dmap:9.6.0) and jetified-location-6.2.0 (com.amap.api:location:6.2.0)
     Duplicate class com.amap.api.fence.GeoFence found in modules jetified-3dmap-9.6.0 (com.amap.api:3dmap:9.6.0) and jetified-location-6.2.0 (com.amap.api:location:6.2.0)
     Duplicate class com.amap.api.fence.GeoFence$1 found in modules jetified-3dmap-9.6.0 (com.amap.api:3dmap:9.6.0) and jetified-location-6.2.0 (com.amap.api:location:6.2.0)

...
```

### 排除重复依赖

上面这些意思就是说amap3d和amap-geolocation冲突了，解决办法是在`./android/app/bundle.gradle`的`dependencies{}`里添加如下内容：（来自这两个项目仓库的[issue](https://github.com/qiuxiang/react-native-amap3d/issues/778#issuecomment-1427649507)）

```javascript
implementation(project(':react-native-amap-geolocation')) {
    exclude group: 'com.amap.api', module: 'location'
}
// 排除重复依赖
```



另外，由于我用的是Android Emulator进行开发，定位是虚拟定位，这里手动设置到上海，然后再测试，成功定位。想必其他API也没问题了。

![成功定位](https://tazdingo-images.oss-cn-hongkong.aliyuncs.com/img/202402290004107.png)
