---
created: 星期一, 十月 14日 2024, 8:51:41 晚上, 1728910301173
modified: 星期一, 十月 14日 2024, 8:51:41 晚上, 1728910301173
---


## malloc和new区别
`malloc` 和 `new` 以及 `free` 和 `delete` 是两组不同的内存分配和释放机制，它们之间有关键的区别，并且 **不能混用**。下面详细解释这四者的区别及原因：

- `malloc/free` 是 C 风格的内存分配和释放方式，适用于原始数据或结构体，不支持对象的构造和析构。
- `new/delete` 是 C++ 风格的动态内存管理方式，适用于需要构造和析构对象的场景。
- 这两组机制不能混用，使用不当会导致内存泄漏或未定义行为。

---

### 1. `malloc` 和 `free`
- **`malloc` (memory allocation)** 是 C 语言中用于动态内存分配的函数。
- **`free`** 是与 `malloc` 对应的内存释放函数。

**特点**：
- `malloc` 只负责分配内存，不会调用构造函数。
- `malloc` 分配的内存大小需要手动指定，参数是要分配的字节数。
  ```c
  int* ptr = (int*)malloc(sizeof(int));  // 分配 sizeof(int) 大小的内存
  ```
- `free` 用于释放 `malloc` 分配的内存，但不会调用析构函数。

**使用场景**：
- C 或者 C++ 中需要手动管理内存时，使用 `malloc` 和 `free` 可以手动分配和释放内存。

### 2. `new` 和 `delete`
- **`new`** 是 C++ 中的运算符，用于动态分配内存并调用构造函数。
- **`delete`** 是与 `new` 对应的运算符，用于释放内存并调用析构函数。

**特点**：
- `new` 不仅分配内存，还调用构造函数来初始化对象。
  ```cpp
  int* ptr = new int;  // 分配一个 int 类型对象的内存，并调用构造函数（如果有）
  ```
- `delete` 释放 `new` 分配的内存，并调用析构函数清理对象。
  ```cpp
  delete ptr;  // 调用析构函数并释放内存
  ```

**使用场景**：
- 在 C++ 中，使用 `new` 和 `delete` 来处理对象的动态分配和释放，保证内存和对象生命周期管理的一致性。

### 3. `malloc` vs `new` 区别
- **内存分配**：
  - `malloc` 仅仅分配内存，返回的指针是 `void*`，必须手动类型转换。
  - `new` 不仅分配内存，还根据分配对象的类型自动调用构造函数。
- **返回类型**：
  - `malloc` 返回 `void*` 类型的指针，需要显式转换为目标类型。
  - `new` 返回具体类型的指针，不需要类型转换。
- **错误处理**：
  - `malloc` 失败时返回 `NULL`。
  - `new` 失败时抛出 `std::bad_alloc` 异常（除非使用 `nothrow` 版本）。
- **初始化**：
  - `malloc` 不会对分配的内存进行初始化，分配的内存区域是未定义的。
  - `new` 会调用对象的构造函数，对分配的内存进行初始化。

### 4. `free` vs `delete` 区别
- **内存释放**：
  - `free` 只释放内存，不会调用对象的析构函数。
  - `delete` 不仅释放内存，还调用析构函数。
- **适用范围**：
  - `free` 只能与 `malloc` 配对使用。
  - `delete` 只能与 `new` 配对使用。
  
### 5. 是否可以混用？
**不能混用**：
- **`malloc` 和 `delete`**：`malloc` 只负责分配原始内存，不涉及构造函数的调用，而 `delete` 会调用析构函数，因此不能用 `delete` 释放由 `malloc` 分配的内存。
- **`new` 和 `free`**：`new` 不仅分配内存，还调用了构造函数，而 `free` 只释放内存，不调用析构函数，因此不能用 `free` 释放由 `new` 分配的内存。

**示例**：
- 正确使用：
  ```cpp
  int* a = (int*)malloc(sizeof(int));
  free(a);  // 正确配对

  int* b = new int;
  delete b;  // 正确配对
  ```
  
- 错误使用：
  ```cpp
  int* a = (int*)malloc(sizeof(int));
  delete a;  // 错误，malloc 与 delete 不兼容

  int* b = new int;
  free(b);  // 错误，new 与 free 不兼容
  ```
