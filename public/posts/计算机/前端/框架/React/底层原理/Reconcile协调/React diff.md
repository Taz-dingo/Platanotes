TAG: React
DECK: 前端
## React diff

React 的 diff 算法被称为 **Reconciliation**（协调），它是 React 用于高效更新用户界面的核心机制。React 在每次状态或属性变化时，会生成新的虚拟 DOM 树（Virtual DOM），然后通过 diff 算法对比新旧虚拟 DOM 树，计算出最小的更新路径，最终更新到真实 DOM 中。

React 的 diff 算法通过逐层对比、`key` 优化等策略优化将原本复杂的 O(n³) 问题简化为 O(n)，并，实现了高效的 UI 更新。这也是 React 运行速度快的核心原因之一。

---

### 背景：为什么需要 diff 算法？
直接对比两个 DOM 树的时间复杂度是 O(n³)，其中 n 是树中的节点数。在实际应用中，DOM 树可能非常复杂，这样的比较代价太高。为了解决这个问题，React 通过以下两点优化，把时间复杂度降低到 O(n)。


### React diff 的核心策略：
1. **树的分层比较**：
   React 假设 DOM 树的不同层级之间的差异很少发生。因此，React 只会对比同一层级的节点，不会跨层级进行比较。换句话说，如果某一层的结构变化，React 会直接删除该层的旧节点，重新创建新节点，而不会尝试移动节点到不同层级。

2. **通过 key 优化子节点比较**：
   在对比同一层级的子节点时，React 使用每个子节点的 `key` 属性来唯一标识每个节点。`key` 帮助 React 在更新列表或子节点时，精确找到需要更新的元素。如果不使用 `key`，React 会采用默认的索引值来进行对比，从而可能引发不必要的节点删除和重新创建。

### Diff 的过程：
假设我们有两个虚拟 DOM 树，React 通过三种操作来完成树的比较：

1. **节点类型相同**：React 会保留 DOM 节点，仅更新属性（Props）。比如从 `<div>` 变成了 `<div>`，React 只会更新变动的属性值。
   
2. **节点类型不同**：如果新旧节点类型不同，比如从 `<div>` 变成了 `<p>`，React 直接删除旧的 DOM 节点，创建新的 DOM 节点，整个子树都会被替换。

3. **元素有 `key`**：对于带 `key` 的列表，React 能够通过 `key` 快速定位哪些元素需要移动、删除或插入，从而避免不必要的操作。例如，假设我们有一个列表，当 key 相同时，React 会复用现有节点，而不会因为顺序改变而重新渲染。

### Diff 算法具体步骤：
1. **比较根节点**：React 会先从根节点开始比较，若类型相同（例如都是 `<div>`），则仅更新属性；若类型不同，则直接移除旧节点，插入新节点。

2. **递归比较子节点**：如果根节点类型相同，React 会递归地比较它们的子节点，并对每个子节点做相应的更新、插入或删除操作。如果子节点中包含 `key` 属性，React 会优先使用 `key` 进行匹配。

3. **列表处理**：对于列表，React 会通过 `key` 来判断哪些元素被修改或顺序改变。在没有 `key` 的情况下，React 仅通过节点顺序来做判断，这可能导致性能下降或意外的 UI 行为。

### React diff 算法的优点：
- **高效性**：通过分层比较和 `key` 来减少不必要的操作，降低了整个更新过程的复杂度。
- **局部更新**：React 只更新需要变化的部分，避免重新渲染整个页面，提升了性能。


END
<!--ID: 1727190963549-->
